<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>情绪地图 · 想见你</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #000; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .heartbeat {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      opacity: 0.5;
      transform: translate(-50%, -50%) scale(1);
      animation: pulse 0.6s ease-out forwards;
      pointer-events: none;
      z-index: 999;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.3; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }
  </style>
</head>
<body>
<div id="map"></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoieGpuMjAyNSIsImEiOiJjbTkxMWJ1cTEwM3NkMm5wdnNkemE4Z24yIn0.ZDf4-d0toG_wjYNsdQvlzw';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/dark-v10',
  center: [144.9631, -37.8136],
  zoom: 12
});

map.on('load', () => {
  const sourceId = 'posts';
  map.addSource(sourceId, {
    type: 'geojson',
    data: './data.geojson'
  });

  // glow 层（呼吸效果）
  map.addLayer({
    id: 'posts-glow',
    type: 'circle',
    source: sourceId,
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        10, 20,
        14, 45
      ],
      'circle-color': [
        'match',
        ['get', 'type'],
        '心愿', '#66ccff',
        '找人', '#ffdd33',
        '#cccccc'
      ],
      'circle-opacity': 0.1,
      'circle-blur': 1.2
    }
  });

  // 主点（模拟泡泡质感：渐变 + 明暗 + 层次）
  map.addLayer({
    id: 'posts-main',
    type: 'circle',
    source: sourceId,
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        10, 6,
        14, 10
      ],
      'circle-color': [
        'match',
        ['get', 'type'],
        '心愿', '#aeeaff',  // 泡泡蓝（略偏亮）
        '找人', '#ffee88',
        '#ffffff'
      ],
      'circle-opacity': 0.9,
      'circle-blur': 0.05,
      'circle-stroke-color': '#ffffff',
      'circle-stroke-width': 0.4
    }
  });

  // 点击识别层
  map.addLayer({
    id: 'posts-click',
    type: 'circle',
    source: sourceId,
    paint: {
      'circle-radius': 20,
      'circle-color': '#000000',
      'circle-opacity': 0
    }
  });

  // 动态光圈逻辑（每个点有呼吸节奏 + likes 控制 base）
  const features = map.getSource(sourceId)._data.features;
  features.forEach((f, i) => {
    map.setFeatureState({ source: sourceId, id: f.id }, {
      base: Math.min(0.05 + (f.properties.likes || 0) * 0.05, 0.6),
      offset: Math.random() * 1000,
      speed: 0.001 + Math.random() * 0.0015
    });
  });

  function animate(t) {
    const opacities = features.map((f) => {
      const state = map.getFeatureState({ source: sourceId, id: f.id });
      const osc = 0.5 + 0.5 * Math.sin(t * state.speed + state.offset);
      return +(state.base * osc).toFixed(3);
    });
    map.setPaintProperty('posts-glow', 'circle-opacity', ['literal', opacities]);
    requestAnimationFrame(animate);
  }
  animate(0);

  // 点击气泡 + Popup
  map.on('click', 'posts-click', (e) => {
    const props = e.features[0].properties;
    const center = map.project(e.lngLat);
    const type = props.type;

    const heart = document.createElement('div');
    heart.className = 'heartbeat';
    heart.style.left = `${center.x}px`;
    heart.style.top = `${center.y}px`;
    heart.style.background = type === '心愿' ? '#66ccff55' : '#ffdd3355';
    document.body.appendChild(heart);
    setTimeout(() => heart.remove(), 600);

    new mapboxgl.Popup()
      .setLngLat(e.lngLat)
      .setHTML(`<strong>${props.title}</strong><br>${props.content}`)
      .addTo(map);
  });

  map.on('mouseenter', 'posts-click', () => {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('mouseleave', 'posts-click', () => {
    map.getCanvas().style.cursor = '';
  });
});
</script>
</body>
</html>
